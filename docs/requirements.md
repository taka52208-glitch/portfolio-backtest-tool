# 投資ポートフォリオ・バックテストツール - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
案件受注に繋がるデモ用の投資ポートフォリオ・バックテストツール。過去の株価データを基に投資戦略のパフォーマンスを検証できるWebアプリケーション。

### 1.2 成功指標

#### 定量的指標
- バックテスト実行が10秒以内に完了する
- 最低3種類以上の資産（株式銘柄）でポートフォリオ構築可能
- 過去5年以上のデータでシミュレーション可能
- 主要な投資指標（リターン、リスク、シャープレシオ、最大ドローダウン）を4つ以上表示

#### 定性的指標
- 投資初心者でも直感的に操作できるUI
- クライアントに「技術力がある」と印象付けられる完成度
- グラフやチャートで結果が視覚的にわかりやすい
- ポートフォリオ入力〜バックテスト結果表示までの流れがスムーズ

---

## 2. システム全体像

### 2.1 主要機能一覧
- **ポートフォリオ構築**: 銘柄選択と投資比率の設定
- **バックテスト実行**: 過去データに基づくパフォーマンス計算
- **結果可視化**: グラフと指標による投資成果の表示

### 2.2 ユーザーロールと権限（MVP版）
- ゲスト: 全機能にアクセス可能（認証不要）

### 2.3 認証・認可要件
- 認証方式: なし（MVP版は認証不要）
- セキュリティレベル: 公開情報のみ扱うため低
- 管理機能: 不要

---

## 3. ページ詳細仕様

### 3.1 P-001: ポートフォリオ入力ページ

#### 目的
ユーザーが投資銘柄と比率を選択し、バックテストを実行するためのメインページ

#### 主要機能
- 銘柄検索・選択（日本株・米国株対応）
- 投資比率（%）の設定（合計100%になるよう調整）
- バックテスト期間の選択（1年/3年/5年）
- バックテスト実行ボタン

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 検索 | 銘柄を検索 | 銘柄コードまたは銘柄名 | 該当銘柄のリスト |
| 設定 | 投資比率を設定 | 各銘柄の比率（%） | 合計100%の確認表示 |
| 実行 | バックテスト実行 | ポートフォリオ情報、期間 | 結果ページへ遷移 |

#### 処理フロー
1. ユーザーが銘柄を検索・選択
2. 各銘柄の投資比率を入力
3. バックテスト期間を選択
4. 「バックテスト実行」ボタンをクリック
5. バックエンドで計算処理
6. 結果ページへ遷移

#### データ構造（概念）
```yaml
PortfolioInput:
  識別子: セッションID（一時的）
  基本情報:
    - 銘柄リスト（必須）
    - 各銘柄の投資比率（必須）
    - バックテスト期間（必須）
  メタ情報:
    - 実行日時
```

---

### 3.2 P-002: バックテスト結果ページ

#### 目的
バックテスト結果をグラフと指標で視覚的に表示し、投資戦略の有効性を確認する

#### 主要機能
- ポートフォリオ価値の推移グラフ（折れ線チャート）
- ベンチマーク（日経225/S&P500）との比較表示
- 主要投資指標の表示
- 新しいバックテストへの導線

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 表示 | 結果グラフ表示 | バックテスト結果データ | 価値推移グラフ |
| 表示 | 指標表示 | 計算結果 | 4つの主要指標 |
| 遷移 | 新規テスト | ボタンクリック | 入力ページへ戻る |

#### 処理フロー
1. バックテスト結果データを受け取る
2. ポートフォリオ価値推移グラフを描画
3. ベンチマークとの比較グラフを描画
4. 主要指標を計算・表示
5. ユーザーは結果を確認後、新規テストへ

#### 表示する指標
```yaml
主要指標:
  - 累積リターン: 期間全体のリターン率（%）
  - 年率リターン: 年換算のリターン率（%）
  - シャープレシオ: リスク調整後リターン
  - 最大ドローダウン: 最大下落幅（%）

比較ベンチマーク:
  - 日経225（日本株選択時）
  - S&P500（米国株選択時）
```

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
StockData:
  概要: 株価の時系列データ（外部APIから取得）
  主要属性:
    - 銘柄コード
    - 日付
    - 始値、高値、安値、終値
    - 出来高
  関連:
    - Portfolio（多対多）

Portfolio:
  概要: ユーザーが構築したポートフォリオ（セッション内のみ）
  主要属性:
    - 銘柄リスト
    - 各銘柄の投資比率
    - バックテスト期間
  関連:
    - BacktestResult（1対1）

BacktestResult:
  概要: バックテスト計算結果
  主要属性:
    - 日次ポートフォリオ価値
    - 累積リターン
    - 年率リターン
    - シャープレシオ
    - 最大ドローダウン
  関連:
    - Portfolio（1対1）
```

### 4.2 エンティティ関係図
```
StockData ──┬── Portfolio ─── BacktestResult
            │    （多対多）      （1対1）
            │
[外部API: yfinance]
```

### 4.3 バリデーションルール
```yaml
銘柄コード:
  - ルール: 有効な銘柄コード形式（日本株: 4桁.T、米国株: アルファベット）
  - 理由: yfinanceで取得可能な銘柄に限定

投資比率:
  - ルール: 0-100の数値、合計100%
  - 理由: ポートフォリオとして成立させるため

バックテスト期間:
  - ルール: 1年/3年/5年から選択
  - 理由: データ取得の安定性と計算時間のバランス
```

---

## 5. 制約事項

### 外部API制限
- **yfinance**: 非公式APIのため、大量リクエスト時に制限の可能性あり（1分100リクエスト推奨）

### 技術的制約
- **データ更新頻度**: リアルタイムではなく日次データを使用
- **銘柄数**: 1ポートフォリオあたり最大10銘柄
- **計算時間**: 10秒以内を目標（5年データ、10銘柄まで）

---

## 5.1 セキュリティ要件

### 基本方針
本プロジェクトは **CVSS 3.1（Common Vulnerability Scoring System）** に準拠したセキュリティ要件を満たすこと。

### MVP判定

**認証機能がない場合（本プロジェクト該当）**:
- ブルートフォース対策は不要
- 基本的なセキュリティヘッダーのみ設定

**その他の一般要件**:
- ✅ HTTPSの強制（本番環境）
- ✅ セキュリティヘッダー設定（本番環境）
- ✅ 入力値のサニタイゼーション（銘柄コード検証）
- ✅ エラーメッセージでの情報漏洩防止

---

### 運用要件：可用性とヘルスチェック

**ヘルスチェックエンドポイント（必須）**:
- エンドポイント: `/api/health`
- 目的: Cloud Runでのliveness/readinessプローブ
- 要件: 5秒以内の応答

**グレースフルシャットダウン（必須）**:
- SIGTERMシグナルハンドラーの実装
- 進行中のリクエスト完了まで待機
- タイムアウト: 8秒（Cloud Runの10秒制限に対応）

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: バックテスト実行
**トリガー**: 「バックテスト実行」ボタンクリック
**フロントエンドAPI**: POST /api/backtest
**バックエンド内部処理**:
1. リクエストバリデーション（銘柄コード、比率、期間）
2. yfinance経由で各銘柄の株価データ取得
3. ポートフォリオ価値の日次計算
4. 投資指標の算出（PyPortfolioOpt/VectorBT）
5. ベンチマークデータ取得・比較計算
6. 結果のJSON整形・返却
**結果**: バックテスト結果（グラフデータ＋指標）
**外部サービス依存**: yfinance

### 複合処理-002: 銘柄検索
**トリガー**: 銘柄検索フィールドへの入力
**フロントエンドAPI**: GET /api/stocks/search?q={query}
**バックエンド内部処理**:
1. クエリのサニタイズ
2. 銘柄マスタから検索（事前キャッシュ or yfinance）
3. 候補リストの返却
**結果**: 銘柄候補リスト（コード、名称）
**外部サービス依存**: yfinance（初回のみ）

---

## 7. 技術スタック

### フロントエンド
```yaml
フレームワーク: React 18
言語: TypeScript 5
UIライブラリ: MUI v6
チャート: ApexCharts
状態管理: Zustand
ルーティング: React Router v6
データフェッチ: React Query
ビルドツール: Vite 5
```

### バックエンド
```yaml
言語: Python 3.12
フレームワーク: FastAPI
株価データ取得: yfinance
ポートフォリオ計算: PyPortfolioOpt
バックテスト: VectorBT
```

### インフラ
```yaml
フロントエンド: Vercel（無料枠）
バックエンド: Google Cloud Run（無料枠）
データベース: なし（MVP版）
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| yfinance | 株価データ取得 | pip install | APIキー不要 |
| Vercel | フロントエンドホスティング | vercel.com | 無料アカウント |
| Google Cloud | バックエンドホスティング | cloud.google.com | 無料枠利用 |

### オプションサービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| 立花証券API | 日本株本番運用時 | e-shiten.jp | 口座開設必要 |

---

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

**（拡張候補 - 実装はしない）**
- 会員登録・ログイン機能
- ポートフォリオ保存・履歴管理
- より詳細な分析指標
- リバランスシミュレーション

---

## 更新履歴

| 日付 | バージョン | 更新内容 |
|------|-----------|---------|
| 2026-01-08 | 1.0 | 初版作成 |
